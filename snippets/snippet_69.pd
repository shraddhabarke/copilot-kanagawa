template <typename T> inline bool equal_by((T, T) -> bool equality_fn, optional<T> x, optional<T> y) { return (!x.is_valid && !y.is_valid) || (x.is_valid && y.is_valid && equality_fn(x.value, y.value)); }